%
% \usepackage{tikz}
% \usepackage{xifthen}
\usetikzlibrary{calc}
%
%             CCDiag v.1.0 
%           D.Kats, September 2011
%
% \bdiag[<scale>] start diagram. If <scale> is given, the diagram will be scaled
% \bdiags[<scale>]: the H diagram will be placed in the middle (otherwise it is shifted halfway to the vacuum)
%
% \dT[<order>]{<exc.level>}{<node>} -> T_<exc.level>^{(<order>)}
% node-names are generated as <node>1, <node>2, <node>3, ...
% can be used without <order> (\dT{<exc.level>}{<node>})
% same with \dU (will print U_<exc.level> as label)
% for excitation operators without label use \dTs
% One can customize labels (see e.g. how \dU is defined)
% \dTd, \dTds, \dUd are T^{\dagger}, {}^{\dagger}, U^{\dagger}
%
% \dTdv[<order>]{<exc.level>}{<node>} : draw vacuum explicitly (\tau^\dagger) 
% \dTv[<order>]{<exc.level>}{<node>} -> \tau
%
% \dF{<node>} -> F
% \dFs{<node>} : one-electron operator without label
% \dX{<node>} : one-electron perturbation (X as label)
% \dHone[<name>]{<node>} : one-electron operator with label <name> 
% \dW{<left node>}{<right node>} -> W
% \dWs{<left node>}{<right node>} : two-electron operator without label
% \dXtwo{<left node>}{<right node>} : two-electron perturbation (X as label)
% \dHtwo[<name>]{<left node>}{<right node>} : two-electron operator with label <name>
%
% \dline[<index>]{<from node>}{<to node>} ->    "--->" (if <index> given - write <index> to the right of the line)
% \dcurve[<index>]{<from node>}{<to node>} ->   curved "--->" 
% \dcurver[<index>]{<from node>}{<to node>} ->   curved "--->" (reverse bend)
% \dcurcur{<node1>}{<node2>} ->     cycled curved "--->"
% \dcurt{<from node>}{<through node>}{<to node>} -> curved "--->" over three nodes! 
% \dcurtr{<from node>}{<through node>}{<to node>} ->   curved "--->" over three nodes (reverse bend) (not needed anymore!)
%
%  left vacuum-node for <node1> is called <node1>v1
%  right -------------"----------------   <node1>v2
%
% \dmovex{<value>} or \dmoveH{<value>} -> move W or F horizontally 
% \dmoveT{<value>} -> move T horizontally
% \dmovac{<value>} -> move vacuum (and daggers) vertically 
% \dmoveTd{<value>} -> move T^\dagger horizontally
%
% \dscale{<value>} -> scale size of diagrams with <value>
%
% \dname{<text>} -> write <text> over the diagram
% \dtext{<text>} -> write <text> in the diagram
%
% change exoper_line_save, exvac_line_save, hoper_line_save, ph_line_save
%  in order to change excitation operator, explicit vacuum, H-operator, or p/h line styles.


\edef\xcoord{11} \edef\xcoor{11} \edef\xcoorbeg{11} \edef\xcoorend{11} \edef\result{11} \edef\ycoor{11} \edef\ycoord{11} \edef\sc{11} 
\pgfmathsetmacro{\sc}{1} %default scale-value
\pgfmathsetmacro{\xcoord}{(-1*\sc)} \pgfmathsetmacro{\ycoord}{(-1*\sc)} 
\pgfmathsetmacro{\xcoor}{\xcoord} \pgfmathsetmacro{\ycoor}{(\ycoord+1*\sc)} 
\pgfmathsetmacro{\xcoordg}{\xcoord}
\pgfmathsetmacro{\xcoorH}{\xcoord}
\pgfmathsetmacro{\yvac}{(\ycoor+0.5*\sc)} \pgfmathsetmacro{\xvac}{(0.25*\sc)} \pgfmathsetmacro{\xdvac}{(0.5*\sc)}
\newcounter{stoer} 
\tikzset{exoper_line_save/.style={very thick, solid}}
\tikzset{exvac_line_save/.style={very thick, dotted}}
\tikzset{hoper_line_save/.style={very thick, dashed}}
\tikzset{ph_line_save/.style={->,>=stealth,thin}}
\tikzset{exoper_line/.style={exoper_line_save}}
\tikzset{hoper_line/.style={hoper_line_save}}
\tikzset{ph_line/.style={ph_line_save}}
\tikzset{ph_liner/.style={ph_line_save,<-}}

\newcommand{\bdiag}[1][]{
 \ifthenelse{\isempty{#1}}
  {\begin{tikzpicture}}
  {\begin{tikzpicture}[scale=#1]}
}
\newcommand{\bdiags}[1][]{
 \ifthenelse{\isempty{#1}}
  {\begin{tikzpicture}}
  {\begin{tikzpicture}[scale=#1]}
  %symmetric diagram
   \pgfmathsetmacro{\yvac}{(\ycoor+1*\sc)}
   \pgfmathsetmacro{\xvac}{(0.5*\sc)}
}
\newcommand{\ediag}{\end{tikzpicture}}

\newcommand{\dAmp}[4][]{%for all
\pgfmathsetmacro{\xcoorbeg}{(\xcoor+0.5*\sc)} 
\pgfmathsetmacro{\xcoorend}{(\xcoorbeg+#3*\sc/2)} 
\draw[exoper_line](\xcoorbeg,\ycoord) -- (\xcoorend,\ycoord);
\pgfmathsetmacro{\result}{(\xcoorend+0.35*\sc)} 
% write label if given
\ifthenelse{\isempty{#1}}  
{\pgfmathsetmacro{\xcoor}{\xcoorend}}
{\node at (\result,\ycoord){#1};
\pgfmathsetmacro{\xcoor}{(\xcoorend+0.25*\sc)}}
% calculate the vertex-distance (singles are a special case)
\ifthenelse{ #3 = 1}
{ \pgfmathsetmacro{\xxx}{((\xcoorend-\xcoorbeg)/2)} 
  \pgfmathsetmacro{\result}{\xcoorbeg}}
{ \pgfmathsetmacro{\xxx}{((\xcoorend-\xcoorbeg)/( #3 - 1 ))} 
  \pgfmathsetmacro{\result}{(\xcoorbeg-\xxx)}}
% set all nodes (and give them names)
\foreach \x in {1,...,#3}
{
  \coordinate (vertex) at ($(\result,\ycoord)+(\x*\xxx,0)$);
  \node[inner sep=0pt,minimum size=0pt] (#4\x) at  (vertex) {};
  \coordinate (vtxvac) at ($(\result,\yvac)+(\x*\xxx,0)$);
  \node[inner sep=0pt,minimum size=0pt] (#4\x v1) at ($(vtxvac)-(\xvac,0)$) {};
  \node[inner sep=0pt,minimum size=0pt] (#4\x v2) at ($(vtxvac)+(\xvac,0)$) {};
}
\node[inner sep=0pt,minimum size=0pt] (#4) at  (#41) {};
\node[inner sep=0pt,minimum size=0pt] (#4v1) at (#41v1) {};
\node[inner sep=0pt,minimum size=0pt] (#4v2) at (#41v2) {};
% set perturbation (if given)
\ifthenelse{\isempty{#2}}  {}  
{ 
\pgfmathsetmacro{\result}{((\xcoorend+\xcoorbeg)/2)} 
\setcounter{stoer}{#2} 
\node[inner sep=0pt,minimum size=0pt] at (\result,\ycoord){{\footnotesize\slshape\sffamily \Roman{stoer}}}; }
}

\newcommand{\dAmpD}[4][]{%for all
\pgfmathsetmacro{\xcoorbeg}{(\xcoordg+0.5*\sc)} 
\pgfmathsetmacro{\xcoorend}{(\xcoorbeg+#3*\sc/2)} 
\draw[exoper_line](\xcoorbeg,\yvac) -- (\xcoorend,\yvac);
\pgfmathsetmacro{\result}{(\xcoorend+0.35*\sc)} 
% write label if given
\ifthenelse{\isempty{#1}}  
{\pgfmathsetmacro{\xcoordg}{\xcoorend}}
{\node at (\result,\yvac){#1};
\pgfmathsetmacro{\xcoordg}{(\xcoorend+0.25*\sc)}}
% calculate the vertex-distance (singles are a special case)
\ifthenelse{ #3 = 1}
{ \pgfmathsetmacro{\xxx}{((\xcoorend-\xcoorbeg)/2)} 
  \pgfmathsetmacro{\result}{\xcoorbeg}}
{ \pgfmathsetmacro{\xxx}{((\xcoorend-\xcoorbeg)/( #3 - 1 ))} 
  \pgfmathsetmacro{\result}{(\xcoorbeg-\xxx)}}
% set all nodes (and give them names)
\foreach \x in {1,...,#3}
{
  \coordinate (vertex) at ($(\result,\yvac)+(\x*\xxx,0)$);
  \node[inner sep=0pt,minimum size=0pt] (#4\x) at  (vertex) {};
  \coordinate (vtxvac) at ($(\result,\ycoord)+(\x*\xxx,0)$);
  \node[inner sep=0pt,minimum size=0pt] (#4\x v1) at ($(vtxvac)-(\xvac,0)$) {};
  \node[inner sep=0pt,minimum size=0pt] (#4\x v2) at ($(vtxvac)+(\xvac,0)$) {};
}
\node[inner sep=0pt,minimum size=0pt] (#4) at  (#41) {};
\node[inner sep=0pt,minimum size=0pt] (#4v1) at (#41v1) {};
\node[inner sep=0pt,minimum size=0pt] (#4v2) at (#41v2) {};
% set perturbation (if given)
\ifthenelse{\isempty{#2}}  {}  
{ 
\pgfmathsetmacro{\result}{((\xcoorend+\xcoorbeg)/2)} 
\setcounter{stoer}{#2} 
\node[inner sep=0pt,minimum size=0pt] at (\result,\yvac){{\footnotesize\slshape\sffamily \Roman{stoer}}}; }
}

\newcommand{\dHone}[2][]{\pgfmathsetmacro{\xcoorbeg}{(\xcoorH+0.5*\sc)}
\pgfmathsetmacro{\xcoorend}{(\xcoorbeg+0.5*\sc)} 
\draw[hoper_line](\xcoorbeg,\ycoor) -- (\xcoorend,\ycoor);
\node at (\xcoorend,\ycoor){$\bf \times$};
\pgfmathsetmacro{\result}{(\xcoorend+0.35*\sc)} 
%name of operator
\ifthenelse{\isempty{#1}}
{\pgfmathsetmacro{\xcoorH}{\xcoorend}}
{\node at (\result,\ycoor){#1};
\pgfmathsetmacro{\xcoorH}{(\xcoorend+0.25*\sc)}}
\node[inner sep=0pt,minimum size=0pt] (#2) at (\xcoorbeg,\ycoor){}; 
\pgfmathsetmacro{\xx}{(\xcoorbeg-\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2v1) at (\xx,\yvac) {}; 
\pgfmathsetmacro{\xx}{(\xcoorbeg+\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2v2) at (\xx,\yvac) {};
\pgfmathsetmacro{\xx}{(\xcoorbeg-\xdvac/2)}
\node[inner sep=0pt,minimum size=0pt] (#2vd1) at (\xx,\ycoord) {};
\pgfmathsetmacro{\xx}{(\xcoorbeg+\xdvac/2)}
\node[inner sep=0pt,minimum size=0pt] (#2vd2) at (\xx,\ycoord) {};
}

\newcommand{\dHoner}[2][]{\pgfmathsetmacro{\xcoorbeg}{(\xcoorH+0.5*\sc)}
\pgfmathsetmacro{\xcoorend}{(\xcoorbeg+0.5*\sc)} 
\draw[hoper_line](\xcoorbeg,\ycoor) -- (\xcoorend,\ycoor);
\node at (\xcoorbeg,\ycoor){$\bf \times$};
\pgfmathsetmacro{\result}{(\xcoorend+0.35*\sc)} 
%name of operator
\ifthenelse{\isempty{#1}}
{\pgfmathsetmacro{\xcoorH}{\xcoorend}}
{\node at (\result,\ycoor){#1};
\pgfmathsetmacro{\xcoorH}{(\xcoorend+0.25*\sc)}}
\node[inner sep=0pt,minimum size=0pt] (#2) at (\xcoorend,\ycoor){}; 
\pgfmathsetmacro{\xx}{(\xcoorend-\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2v1) at (\xx,\yvac) {}; 
\pgfmathsetmacro{\xx}{(\xcoorend+\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2v2) at (\xx,\yvac) {};
\pgfmathsetmacro{\xx}{(\xcoorend-\xdvac/2)}
\node[inner sep=0pt,minimum size=0pt] (#2vd1) at (\xx,\ycoord) {};
\pgfmathsetmacro{\xx}{(\xcoorend+\xdvac/2)}
\node[inner sep=0pt,minimum size=0pt] (#2vd2) at (\xx,\ycoord) {};
}

\newcommand{\dHtwo}[3][]{ \pgfmathsetmacro{\xcoorbeg}{(\xcoorH+0.5*\sc)}
\pgfmathsetmacro{\xcoorend}{(\xcoorbeg+1*\sc)} 
\draw[hoper_line](\xcoorbeg,\ycoor) -- (\xcoorend,\ycoor); 
\pgfmathsetmacro{\result}{(\xcoorend+0.35*\sc)} 
%name of operator
\ifthenelse{\isempty{#1}}
{\pgfmathsetmacro{\xcoorH}{\xcoorend}}
{\node at (\result,\ycoor){#1};
\pgfmathsetmacro{\xcoorH}{(\xcoorend+0.25*\sc)}}
\node[inner sep=0pt,minimum size=0pt] (#2) at (\xcoorbeg,\ycoor) {};
\node[inner sep=0pt,minimum size=0pt] (#3) at (\xcoorend,\ycoor) {};
\pgfmathsetmacro{\xx}{(\xcoorbeg-\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2v1) at (\xx,\yvac) {};
\pgfmathsetmacro{\xx}{(\xcoorbeg+\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2v2) at (\xx,\yvac) {}; 
\pgfmathsetmacro{\xx}{(\xcoorend-\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#3v1) at (\xx,\yvac) {};
\pgfmathsetmacro{\xx}{(\xcoorend+\xvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#3v2) at (\xx,\yvac) {};
\pgfmathsetmacro{\xx}{(\xcoorbeg-\xdvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2vd1) at (\xx,\ycoord) {};
\pgfmathsetmacro{\xx}{(\xcoorbeg+\xdvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#2vd2) at (\xx,\ycoord) {}; 
\pgfmathsetmacro{\xx}{(\xcoorend-\xdvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#3vd1) at (\xx,\ycoord) {};
\pgfmathsetmacro{\xx}{(\xcoorend+\xdvac/2)} 
\node[inner sep=0pt,minimum size=0pt] (#3vd2) at (\xx,\ycoord) {};
} 

%general excitations
\newcommand{\dT}[3][]{\dAmp[$_{T_#2}$]{#1}{#2}{#3}}
\newcommand{\dTs}[3][]{\dAmp{#1}{#2}{#3}}
\newcommand{\dU}[3][]{\dAmp[$_{U_#2}$]{#1}{#2}{#3}}
\newcommand{\dTv}[3][]{
\tikzset{exoper_line/.style={exvac_line_save}}
\dAmp{#1}{#2}{#3}
\tikzset{exoper_line/.style={exoper_line_save}} }

\newcommand{\dTd}[3][]{\dAmpD[$_{T^{\dagger}_#2}$]{#1}{#2}{#3}}
\newcommand{\dTds}[3][]{\dAmpD{#1}{#2}{#3}}
\newcommand{\dUd}[3][]{\dAmpD[$_{U^{\dagger}_#2}$]{#1}{#2}{#3}}
\newcommand{\dTdv}[3][]{
\tikzset{exoper_line/.style={exvac_line_save}}
\dAmpD{#1}{#2}{#3}
\tikzset{exoper_line/.style={exoper_line_save}} }

%Hamilton parts
\newcommand{\dF}[1]{\dHone[$_{F}$]{#1}}
\newcommand{\dFs}[1]{\dHone{#1}}
\newcommand{\dX}[1]{\dHone[$_{X}$]{#1}}

\newcommand{\dFr}[1]{\dHoner[$_{F}$]{#1}}
\newcommand{\dFsr}[1]{\dHoner{#1}}
\newcommand{\dXr}[1]{\dHoner[$_{X}$]{#1}}

\newcommand{\dW}[2]{\dHtwo[$_{W}$]{#1}{#2}}
\newcommand{\dWs}[2]{\dHtwo{#1}{#2}}
\newcommand{\dXtwo}[2]{\dHtwo[$_{X}$]{#1}{#2}}

\newcommand{\dline}[3][]{
\ifthenelse{\isempty{#1}}
{\draw[ph_line](#2) -- (#3);}
{\draw[ph_line](#2) -- node[inner sep=0pt,minimum size=0pt,right = 0.5pt] {\footnotesize\slshape\sffamily #1} (#3);}
}
\newcommand{\dcurve}[3][]{
\ifthenelse{\isempty{#1}}
{\draw[ph_line](#2) to [bend right=30] (#3);}
{\draw[ph_line](#2) to [bend right=30] node[inner sep=0pt,minimum size=0pt,right = 0.5pt] {\footnotesize\slshape\sffamily #1} (#3);}
}
\newcommand{\dcurver}[3][]{
  \tikzset{ph_line/.style={ph_liner}}
  \dcurve[#1]{#3}{#2}
  \tikzset{ph_line/.style={ph_line_save}}
}
\newcommand{\dcurcur}[2]{\dcurve{#1}{#2} \dcurve{#2}{#1}}

\newcommand{\dcurt}[3]{
  \draw[ph_line] let \p1 = (#1), \p2 = (#2)
    in \pgfextra{
        \pgfmathsetmacro{\dx}{\x2==\x1}
        \pgfmathsetmacro{\dy}{\y2>\y1}
        \pgfmathsetmacro{\ang}{90-2*atan((\y2-\y1)/(\x2-\x1+\dx/10))}
        \pgfmathsetmacro{\ango}{180*(1-\dy) - \ang}
        \pgfmathsetmacro{\angi}{90-180*\dy }
       }
    (#1) to [out=\ango,in=\angi] (#2);
  \draw[ph_line] let \p1 = (#2), \p2 = (#3)
    in \pgfextra{
        \pgfmathsetmacro{\dx}{\x2==\x1}
        \pgfmathsetmacro{\dy}{\y2>\y1}
        \pgfmathsetmacro{\ang}{90+2*atan((\y2-\y1)/(\x2-\x1+\dx/10))}
        \pgfmathsetmacro{\angi}{180*(1-\dy) + \ang}
        \pgfmathsetmacro{\ango}{180*\dy -90 }
       }
    (#2) to [out=\ango,in=\angi] (#3);
}
% switch to this one if TexLive2011 is available
%\newcommand{\dcurt}[3]{
  %\draw[ph_line] let \p1 = (#1), \p2 = (#2)
    %in \pgfextra{
        %\pgfmathsetmacro{\dx}{\x2==\x1 ? 1 : \x2-\x1 } 
        %\pgfmathsetmacro{\ang}{\x2==\x1? -90 :90-2*atan((\y2-\y1)/(\dx))}
        %\pgfmathsetmacro{\sang}{\y2>\y1? -1 : 1}
        %\pgfmathsetmacro{\ango}{\y2>\y1? -\ang : 180 - \ang}
        %\pgfmathsetmacro{\angi}{\y2>\y1? -90 : 90}
       %}
    %(#1) to [out=\ango,in=\angi] (#2);
  %\draw[ph_line] let \p1 = (#2), \p2 = (#3)
    %in \pgfextra{
        %\pgfmathsetmacro{\dx}{\x2==\x1 ? 1 : \x2-\x1 }
        %\pgfmathsetmacro{\ang}{\x2==\x1 ? -90 : 90+2*atan((\y2-\y1)/(\dx))}
        %\pgfmathsetmacro{\angi}{\y2>\y1? \ang : 180 + \ang}
        %\pgfmathsetmacro{\ango}{\y2>\y1? 90 : -90}
       %}
    %(#2) to [out=\ango,in=\angi] (#3);
%}
\newcommand{\dcurtr}[3]{
  \tikzset{ph_line/.style={ph_liner}}
  \dcurt{#3}{#2}{#1}
  \tikzset{ph_line/.style={ph_line_save}}  
}

\newcommand{\dmoveH}[1]{\pgfmathsetmacro{\xcoorH}{(\xcoorH+#1*0.25*\sc)}}
\newcommand{\dmoveT}[1]{\pgfmathsetmacro{\xcoor}{(\xcoor+#1*0.25*\sc)}}
\newcommand{\dmoveTd}[1]{\pgfmathsetmacro{\xcoordg}{(\xcoordg+#1*0.25*\sc)}}
\newcommand{\dmovac}[1]{\pgfmathsetmacro{\yvac}{(\yvac+#1*0.25*\sc)}}
\newcommand{\dmovex}[1]{\dmoveH{#1}} %alias
\newcommand{\dname}[1]{
\pgfmathsetmacro{\xx}{(\xcoord+1*\sc)} \pgfmathsetmacro{\result}{(\yvac+0.25*\sc)} 
\node at (\xx,\result) {#1};}
\newcommand{\dtext}[2]{\pgfmathsetmacro{\xx}{(\xcoord+#1*\sc)} \pgfmathsetmacro{\result}{((\ycoord+\yvac)/2)} 
\node at (\xx,\result) {#2};}

\newcommand{\dscale}[1]{\pgfmathsetmacro{\sc}{#1} 
\pgfmathsetmacro{\xcoord}{(-1*\sc)} \pgfmathsetmacro{\ycoord}{(-1*\sc)} 
\pgfmathsetmacro{\xcoor}{\xcoord} \pgfmathsetmacro{\ycoor}{(\ycoord+1*\sc)} 
\pgfmathsetmacro{\xcoordg}{\xcoord}
\pgfmathsetmacro{\xcoorH}{\xcoord}
\pgfmathsetmacro{\yvac}{(\yvac*\sc)} \pgfmathsetmacro{\xvac}{(\xvac*\sc)}}
% end of CCDiag


% test:
% \bdiag
% \dmovex{2}
% \dT{1}{t}
% \dT{2}{t2}
% \dW{wn1}{wn2}
% \dline{t1}{wn1}
% \dline{t1v1}{t1}
% \dline{t21}{wn2}
% \dline{t21}{t2v1}
% \dline{wn1}{wn1v2}
% \dline{wn2}{wn2v2}
% \dline{t22v1}{t22}
% \dline{t22}{t22v2}
% \ediag
